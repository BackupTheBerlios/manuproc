// $Id: selAufEntry_sql.pgcc,v 1.20 2002/06/27 07:42:50 christof Exp $
/*  libcommonc++: ManuProC's main OO library
 *  Copyright (C) 1998-2000 Adolf Petig GmbH & Co. KG, written by Jacek Jakubowski
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 */

#include <Auftrag/selFullAufEntry.h>
#include <Aux/Transaction.h>
#include <Aux/Datum.h>

exec sql include sqlca;

SelectedFullAufList::SelectedFullAufList
	(const SQLFullAuftragSelector &selector)
throw(SQLerror)
{
 exec sql begin declare section;
 int AUFID[20];
 int INSTANZ[20];
 int ZNUMMER[20];
 int KDNR[20];
 int ARTIKELID[20];
 int ROHARTIKELID[20];
 int BESTELLT[20], GELIEFERT[20];
 char LIEFERDATUM[20][21];
 int ILIEFERDATUM[20];
 int PROZESSID[20],LETZTEPLANINSTANZ[20],MAXPLANINSTANZ[20];
 char PROZESSDATUM[20][11];
 int STATUS[20];
 int ENTRYSTATUS[20];
 int LASTEDITDATEUID[20];
 char LASTEDITDATE[20][21];
 char LETZTELIEFERUNG[20][21];
 int DISPOENTNR[20];
 int DISPONR[20];
 int IDISPOENTNR[20], IDISPONR[20];
 char YOURAUFNR[20][21];
 int IYOURAUFNR[20];
 int IROHARTIKELID[20];
 float PREIS[20];
 float RABATT[20];
 int PREISMENGE[20];
 int WAEHRUNG[20];
 int IPREIS[20],IRABATT[20],IWAEHRUNG[20];
 int PREISLISTE[20];
 char *clausel;
 exec sql end declare section;
	
	clausel = (char *)selector.getClausel().c_str();

	Transaction tr;
	exec sql prepare MYQ from :clausel;
	exec sql declare AUFENTRYFULL cursor for MYQ;
	exec sql open AUFENTRYFULL;
	SQLerror::test(__FILELINE__":SelectedFullAufList: select all auftragids",100);

	while(1)
	  {
	   exec sql fetch 20 in AUFENTRYFULL
	   into :INSTANZ, :AUFID, :ZNUMMER,
		:BESTELLT, :ARTIKELID, :ROHARTIKELID:IROHARTIKELID,
		:LIEFERDATUM:ILIEFERDATUM,
		:GELIEFERT, 
		:STATUS, :KDNR, :YOURAUFNR:IYOURAUFNR,
		:PROZESSID, :LETZTEPLANINSTANZ, :MAXPLANINSTANZ, :PROZESSDATUM,
		:PREIS:IPREIS, :RABATT:IRABATT, :PREISMENGE,
		:WAEHRUNG:IWAEHRUNG,
		:ENTRYSTATUS, :LASTEDITDATEUID,:LASTEDITDATE, :LETZTELIEFERUNG, :PREISLISTE ;
   SQLerror::test(__FILELINE__":SelectedFullAufList: fetch all auftragids",
						"AUFENTRYFULL",100);

	   int j=sqlca.sqlerrd[2];
           for (int i=0;i<j;++i)
           { 
         try {
//         ManuProC::Datum datum(); datum->from_postgres(PROZESSDATUM[i]);
	      aufidliste.push_back(
			AufEintrag(ppsInstanz::ID(INSTANZ[i]),
			AUFID[i], ZNUMMER[i], BESTELLT[i], ARTIKELID[i],
      	ILIEFERDATUM[i] ? ManuProC::Datum() : ManuProC::Datum(LIEFERDATUM[i]),
			GELIEFERT[i],
			IDISPOENTNR[i] ? 0 : DISPOENTNR[i],
			IDISPONR[i] ? 0 : DISPONR[i],
			AufStatVal(STATUS[i]), KDNR[i],
			IYOURAUFNR[i] ? std::string("") : std::string(YOURAUFNR[i]),
			ManuProC::Datum(PROZESSDATUM[i]),
//ManuProC::Datum()
         PROZESSID[i], // wird nicht mehr gebraucht -- oder ?
         ppsInstanz::ID(LETZTEPLANINSTANZ[i]),MAXPLANINSTANZ[i],
			Preis(IPREIS[i] ? 0 : PREIS[i],
				IWAEHRUNG[i] ? Waehrung::ID(0):Waehrung::ID(WAEHRUNG[i]),
				PREISMENGE[i]),
			IRABATT[i] ? 0 : RABATT[i],
		(AufStatVal)ENTRYSTATUS[i],LASTEDITDATEUID[i],ManuProC::Datum(LASTEDITDATE[i]),
		 ManuProC::Datum(LETZTELIEFERUNG[i]),PREISLISTE[i]));
	      } catch (SQLerror &e)
	      {  std::cerr << e << '\n';
	      }
	   }

	   if (j<20) break;
	  }	   	

	exec sql close AUFENTRYFULL;
	tr.commit();
}


void SelectedFullAufList::insert(const AufEintragBase& aeb) throw(SQLerror)
{
 exec sql begin declare section;
 int INSTANZ;
 int AUFID;
 int ZNUMMER;
 int KDNR;
 int ARTIKELID;
 int ROHARTIKELID;
 int BESTELLT, GELIEFERT;
 char LIEFERDATUM[21];
 int ILIEFERDATUM;
 int PROZESSID,LETZTEPLANINSTANZ,MAXPLANINSTANZ;
 char PROZESSDATUM[11];
 int STATUS;
 int ENTRYSTATUS;
 int LASTEDITDATEUID;
 char LASTEDITDATE[21];
 char LETZTELIEFERUNG[21];
 int DISPOENTNR=0;
 int DISPONR=0;
 int IDISPOENTNR=-1, IDISPONR=-1;
 char YOURAUFNR[21];
 int IYOURAUFNR;
 int IROHARTIKELID;
 float PREIS;
 float RABATT;
 int PREISMENGE;
 int WAEHRUNG;
 int IPREIS,IRABATT,IWAEHRUNG;
 int PREISLISTE;
 char *clausel;
 exec sql end declare section;

 std::string cmd=SQLFullAuftragSelector(
		SQLFullAuftragSelector::sel_AufidZnr(aeb)).getClausel();
	clausel = (char *)cmd.c_str();

	Transaction tr;
	exec sql prepare MYQ from :clausel;
	exec sql declare AUFENTRYINSERT cursor for MYQ;
	exec sql open AUFENTRYINSERT;
	SQLerror::test(__FILELINE__":SelectedFullAufList::insert: select all auftragids");

	   exec sql fetch in AUFENTRYINSERT
	   into :INSTANZ, :AUFID, :ZNUMMER,
		:BESTELLT, :ARTIKELID, :ROHARTIKELID:IROHARTIKELID,
		:LIEFERDATUM:ILIEFERDATUM,
		:GELIEFERT, 
		:STATUS, :KDNR, :YOURAUFNR:IYOURAUFNR,
		:PROZESSID, :LETZTEPLANINSTANZ, :MAXPLANINSTANZ, :PROZESSDATUM,
		:PREIS:IPREIS, :RABATT:IRABATT, :PREISMENGE,
		:WAEHRUNG:IWAEHRUNG,
		:ENTRYSTATUS, :LASTEDITDATEUID,:LASTEDITDATE, :LETZTELIEFERUNG, :PREISLISTE;
   SQLerror::test(__FILELINE__":SelectedFullAufList::insert: fetch all auftragids",
						"AUFENTRYINSERT");

	      aufidliste.push_back(
			AufEintrag((ppsInstanz::ID)INSTANZ,
			AUFID, ZNUMMER, BESTELLT, ARTIKELID,
      	ILIEFERDATUM ? ManuProC::Datum() : ManuProC::Datum(LIEFERDATUM),
			GELIEFERT,
			IDISPOENTNR ? 0 : DISPOENTNR,
			IDISPONR ? 0 : DISPONR,
			(AufStatVal)STATUS, KDNR,
			IYOURAUFNR ? std::string("") : std::string(YOURAUFNR),
			ManuProC::Datum(PROZESSDATUM),PROZESSID,
			ppsInstanz::ID(LETZTEPLANINSTANZ),MAXPLANINSTANZ,
			Preis(IPREIS ? 0 : PREIS,
				IWAEHRUNG ? Waehrung::ID(0):Waehrung::ID(WAEHRUNG),
				PREISMENGE),
			IRABATT ? 0 : RABATT,
			(AufStatVal)ENTRYSTATUS,LASTEDITDATEUID,ManuProC::Datum(LASTEDITDATE),
			ManuProC::Datum(LETZTELIEFERUNG),PREISLISTE
			));

	exec sql close AUFENTRYINSERT;
	tr.commit();
}

